"use strict";angular.module("lformsApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAnimate","ngMaterial","lformsWidget","angularFileUpload"]).config(["$ariaProvider",function(e){e.config({tabindex:!1,bindRoleForClick:!1})}]).config(["$routeProvider","$locationProvider",function(e,n){e.when("/lforms-fhir-app",{templateUrl:"fhir-app/fhir-app.html",controller:"FhirAppCtrl"}).when("/",{templateUrl:"fhir-app/fhir-app.html",controller:"FhirAppCtrl"}),n.html5Mode(!0)}]);var LFormsUtil=LFormsUtil||{};LFormsUtil.copyToClipboard=function(e){window.getSelection().selectAllChildren(document.getElementById(e)),document.execCommand("Copy")},angular.module("lformsApp").constant("fhirServerConfig",{listFhirServers:[{url:"https://launch.smarthealthit.org/v/r3/fhir"},{url:"https://lforms-fhir.nlm.nih.gov/baseDstu3"},{url:"https://lforms-fhir.nlm.nih.gov/baseR4",smartServiceUrl:"https://lforms-smart-fhir.nlm.nih.gov/v/r4/fhir",featuredQuestionnaires:[{name:"US Surgeon General family health portrait",id:"54127-6-x",code:"54127-6"},{name:"Weight & Height tracking panel",id:"55418-8-x",code:"55418-8"},{name:"Comprehensive metabolic 1998 panel",id:"24322-0-x",code:"24322-0"},{name:"PHQ-9 quick depression assessment panel",id:"44249-1-x",code:"44249-1"},{name:"Hard Coronary Heart Disease (10-year risk)",id:"framingham-hchd-lhc"},{name:"Health Screening",id:"sdoh-health-screening"},{name:"Study drug toxicity panel",id:"study-drug-tox-x"},{name:"AHC HRSN Screening",id:"lforms-ahn-hrsn-screening"}]}]}),angular.module("lformsApp").controller("FhirAppContentCtrl",["$scope","$window","$http","$timeout","$routeParams","selectedFormData","$mdDialog","fhirService","userMessages",function(a,e,n,t,r,s,i,l,c){var o="R4";a.initialLoad=!0,a.previewOptions={hideCheckBoxes:!0},a.lfOptions={showQuestionCode:!0,showCodingInstruction:!1,tabOnInputFieldsOnly:!1,showFormHeader:!1},a.fhirResInfo={resId:null,resType:null,resTypeDisplay:null,extensionType:null,questionnaireResId:null,questionnaireName:null},a.userMessages=c,a.valueCleanUp=function(e){for(var n=angular.copy(e),t=0,r=n.itemList.length;t<r;t++)delete n.itemList[t].value;return n},a.saveQRToFhir=function(){$(".spinner").show(),"QuestionnaireResponse"===a.fhirResInfo.resType&&(a.fhirResInfo.resId?a.updateQRToFhir(a.fhirResInfo.extensionType):a.createQRToFhir(a.fhirResInfo.extensionType))},a.deleteFromFhir=function(){$(".spinner").show(),a.fhirResInfo.resId&&l.deleteQRespAndObs(a.fhirResInfo.resId)},a.saveAsToFhir=function(e){$(".spinner").show(),"QR"===e?a.createQRToFhir():"SDC-QR"===e&&a.createQRToFhir("SDC")},a.saveAsQRExtracted=function(){$(".spinner").show();var e,n=LForms.Util.getFormFHIRData("QuestionnaireResponse",l.fhirVersion,a.formData,{extract:!0,subject:l.getCurrentPatient()});if(a.fhirResInfo.questionnaireResId){var t={id:a.fhirResInfo.questionnaireResId,name:a.fhirResInfo.questionnaireName};e=!0}else{var r=a.valueCleanUp(a.formData);t=LForms.Util.getFormFHIRData("Questionnaire",l.fhirVersion,r);e=!1}var i=n.shift();l.createQQRObs(t,i,n,e)},a.saveDRToFhir=function(){var e=LForms.FHIR.createDiagnosticReport(a.formData,l.getCurrentPatient().resource,!0,"transaction");e?l.handleTransactionBundle(e):console.log("Failed to create a DiagnosticReport. "+JSON.stringify(a.formData))},a.createQRToFhir=function(e){$(".spinner").show();var n="SDC"!==e,t=LForms.Util.getFormFHIRData("QuestionnaireResponse",l.fhirVersion,a.formData,{noExtensions:n,subject:l.getCurrentPatient()});if(t)if(delete t.id,a.fhirResInfo.questionnaireResId){var r={id:a.fhirResInfo.questionnaireResId,name:a.fhirResInfo.questionnaireName};l.createQR(t,r,e)}else{var i=a.valueCleanUp(a.formData),o=LForms.Util.getFormFHIRData("Questionnaire",l.fhirVersion,i);o?(delete o.id,l.createQQR(o,t,e)):console.log("Failed to create a Questionnaire. "+JSON.stringify(a.formData))}else console.log("Failed to create a QuestionnaireResponse. "+JSON.stringify(a.formData))},a.updateQRToFhir=function(e){$(".spinner").show();var n="SDC"!==e;if(a.fhirResInfo.resId&&a.fhirResInfo.questionnaireResId){var t=LForms.Util.getFormFHIRData("QuestionnaireResponse",l.fhirVersion,a.formData,{noExtensions:n});if(t){var r=l.getCurrentPatient();r&&(t.subject={reference:"Patient/"+r.id,display:r.name}),l.setQRRefToQ(t,{id:a.fhirResInfo.questionnaireResId}),t.id=a.fhirResInfo.resId,l.updateFhirResource("QuestionnaireResponse",t)}else console.log("Failed to update a QuestionnaireResponse. "+JSON.stringify(a.formData))}},a.showHL7Segments=function(e){a.formData&&(a.hl7String=LForms.HL7.toHL7Segments(a.formData),i.show({scope:a,preserveScope:!0,templateUrl:"fhir-app/hl7-dialog.html",parent:angular.element(document.body),targetEvent:e}))},a.showFHIRDiagnosticReport=function(e){if(a.formData){var n=LForms.Util.getFormFHIRData("DiagnosticReport",o,a.formData,{bundleType:"collection"}),t=(n=LForms.FHIR.createDiagnosticReport(a.formData,l.getCurrentPatient().resource,!0,"collection"),JSON.stringify(n,null,2));a.fhirResourceString=t,a.fhirResourceTitle="FHIR DiagnosticReport Resource",i.show({scope:a,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},a.showOrigFHIRQuestionnaire=function(e){var n=l.getCurrentQuestionnaire();if(n){var t=JSON.stringify(n,null,2),r=l.getServerServiceURL();t=t.replace(/"id": "([^\s"]+)"/,'"id": "<a href="'+r+'/Questionnaire/$1" target=_blank>$1</a>"'),a.fhirResourceString=t,a.fhirResourceTitle="Questionnaire Resource from FHIR Server",i.show({scope:a,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},a.showFHIRQuestionnaire=function(e){if(a.formData){var n=a.valueCleanUp(a.formData),t=LForms.Util.getFormFHIRData("Questionnaire",o,n,{noExtensions:!0}),r=JSON.stringify(t,null,2);r=r.replace(/"id": "(\d+)"/,'"id": "<a href="'+a.serverBaseURL+'/Questionnaire/$1">Questionnaire/$1</a>'),a.fhirResourceString=r,a.fhirResourceTitle="FHIR Questionnaire Resource",i.show({scope:a,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},a.showFHIRSDCQuestionnaire=function(e){if(a.formData){var n=a.valueCleanUp(a.formData),t=LForms.Util.getFormFHIRData("Questionnaire",o,n),r=JSON.stringify(t,null,2);a.fhirResourceString=r,a.fhirResourceTitle="FHIR SDC Questionnaire Resource",i.show({scope:a,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},a.showFHIRQuestionnaireResponse=function(e){if(a.formData){var n=LForms.Util.getFormFHIRData("QuestionnaireResponse",o,a.formData,{noExtensions:!0,subject:l.getCurrentPatient()}),t=JSON.stringify(n,null,2);a.fhirResourceString=t,a.fhirResourceTitle="FHIR QuestionnaireResponse Resource",i.show({scope:a,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},a.showFHIRSDCQuestionnaireResponse=function(e){if(a.formData){var n=LForms.Util.getFormFHIRData("QuestionnaireResponse",o,a.formData,{subject:l.getCurrentPatient()}),t=JSON.stringify(n,null,2);a.fhirResourceString=t,a.fhirResourceTitle="FHIR SDC QuestionnaireResponse Resource",i.show({scope:a,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},a.closeDialog=function(){i.hide()},a.copyToClipboard=function(e){LFormsUtil.copyToClipboard(e)},a.$on("LF_FHIR_QR_CREATED",function(e,n){a.fhirResInfo.resId=n.resId,a.fhirResInfo.resType=n.resType,n.qResId&&(a.fhirResInfo.questionnaireResId=n.qResId,a.fhirResInfo.questionnaireName=n.qName),a.fhirResInfo.extensionType=n.extensionType,"QuestionnaireResponse"===n.resType&&n.extensionType?a.fhirResInfo.resTypeDisplay=n.resType+" ("+n.extensionType+")":a.fhirResInfo.resTypeDisplay=n.resType,$(".spinner").hide()}),a.$on("LF_FHIR_RESOURCE_DELETED",function(e,n){s.setFormData(null),fhirResInfo={},a.initialLoad=!0,a.$apply(),$(".spinner").hide()}),a.$on("LF_NEW_DATA",function(){var e=s.getFormData();e&&(e.templateOptions.showFormHeader=!1),a.fhirResInfo=s.getFhirResInfo(),a.formData=e,a.initialLoad&&e&&(a.initialLoad=!1),$(".spinner").hide()}),a.$on("LF_FHIR_RESOURCE",function(e,n){if("Questionnaire"===n.resType){var t,r=n.resource,i=l.fhirVersion;try{r=lformsUpdater.update(r),t=LForms.Util.convertFHIRQuestionnaireToLForms(r,i),t=new LForms.LFormsData(t)}catch(e){console.error(e),c.error="Sorry.  Could not process that Questionnaire.  See the console for details."}if(t){var o={resId:null,resType:"QuestionnaireResponse",resTypeDisplay:"QuestionnaireResponse (SDC)",extensionType:"SDC",questionnaireResId:r.id,questionnaireName:r.name};$(".spinner").show(),t.loadFHIRResources(!0).then(function(){$(".spinner").hide(),a.$apply(function(){s.setFormData(t,o),l.setCurrentQuestionnaire(r)})}),t.templateOptions.showFormHeader=!1}}a.fhirResInfo=s.getFhirResInfo(),a.formData=t,a.initialLoad&&t&&(a.initialLoad=!1),$(".spinner").hide()})}]),angular.module("lformsApp").controller("NavBarCtrl",["$scope","$http","$mdDialog","selectedFormData","fhirService","FileUploader","userMessages","$timeout","fhirServerConfig",function(m,e,t,l,g,n,c,a,r){function d(){for(var e=Object.keys(c),n=0,t=e.length;n<t;++n)delete c[e[n]]}function v(e){var n=e.title||e.name||e.code&&e.code.length&&e.code[0].display;if(e.code&&e.code.length){var t=e.code[0];"http://loinc.org"==t.system&&t.code&&(n=n||"",n+=" ["+t.code+"]")}return n=n||"Untitled, #"+e.id}m.search={},m.uploader=new n({removeAfterUpload:!0}),m.listFeaturedQ=g.getFeaturedQs(),m.listSavedQR=null,m.listSavedQ=null,m.formSelected={},m.obrItems=[{question:"Effective Date",questionCode:"date_done",dataType:"DT",answers:"",_answerRequired:!0,answerCardinality:{min:"1",max:"1"},displayControl:{colCSS:[{name:"width",value:"100%"},{name:"min-width",value:"4em"}]}}],m.loadFromFile=function(){document.querySelector("#inputAnchor").click()},m.uploader.onAfterAddingFile=function(e){l.setFormData(null),a(function(){d()});var n=new FileReader;n.onload=function(e){try{var n=JSON.parse(e.target.result)}catch(e){a(function(){c.error=e})}if(n)if((n=lformsUpdater.update(n)).resourceType&&"Questionnaire"===n.resourceType){var t;try{var r=LForms.Util.detectFHIRVersion(n);if(!r){r=LForms.Util.guessFHIRVersion(n);var i='specified via meta.profile (see documentation for versioning <a href="http://build.fhir.org/versioning.html#mp-version">resources</a> and <a href="https://www.hl7.org/fhir/references.html#canonical">canonical URLs</a>).</p><p>Example 1:  http://hl7.org/fhir/4.0/StructureDefinition/Questionnaire (for Questionnaire version 4.0).<br>Example 2:  http://hl7.org/fhir/3.0/StructureDefinition/Questionnaire (for Questionnaire version 3.0).<br>Example 3:  http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire|2.7.0  (for SDC Questionnaire version 2.7).</p>';a(r?function(){c.htmlWarning="<p>Warning:  Assuming this resource is for FHIR version "+r+".To avoid this warning, please make sure the FHIR version is "+i}:function(){c.htmlError="<p>Could not determine the FHIR version for this resource.  Please make sure it is "+i})}console.log("fhirVersion for uploaded Questionnaire = "+r),r=LForms.Util.validateFHIRVersion(r),t=LForms.Util.convertFHIRQuestionnaireToLForms(n,r)}catch(e){a(function(){c.error=e})}t&&a(function(){$(".spinner").show();var e=new LForms.LFormsData(t);LForms.fhirContext?e.loadFHIRResources(!0).then(function(){$(".spinner").hide(),m.$apply(function(){l.setFormData(e),g.setCurrentQuestionnaire(null),m.formSelected=null})}):l.setFormData(e)})}else a(function(){l.setFormData(new LForms.LFormsData(n))})},n.readAsText(e._file),$("#inputAnchor")[0].value=""},m.pagingLinks={Questionnaire:{previous:null,next:null},QuestionnaireResponse:{previous:null,next:null}},m.hasPagingLink=function(e,n){return m.pagingLinks[e][n]},m.getPage=function(e,n){var t=m.pagingLinks[e][n];t&&g.getPage(e,n,t)},m.processPagingLinks=function(e,n){for(var t={previous:null,next:null},r=0,i=n.length;r<i;r++){var o=n[r];"previous"!==o.relation&&"next"!==o.relation||(t[o.relation]=o.url)}m.pagingLinks[e]=t},m.showSavedQQR=function(e,n){if(n&&"QuestionnaireResponse"===n.resType){$(".spinner").show(),d(),l.setFormData(null),m.formSelected={groupIndex:1,formIndex:e};var t,r=g.fhirVersion;try{var i=lformsUpdater.update(n.questionnaire),o=LForms.Util.convertFHIRQuestionnaireToLForms(i,r),a=new LForms.LFormsData(o);t=LForms.Util.mergeFHIRDataIntoLForms("QuestionnaireResponse",n.questionnaireresponse,a,r)}catch(e){console.error(e),c.error="Sorry.  Could not process that QuestionnaireResponse.  See the console for details."}if(t){var s={resId:n.resId,resType:n.resType,resTypeDisplay:n.resTypeDisplay,extensionType:n.extensionType,questionnaireResId:n.questionnaire.id,questionnaireName:n.questionnaire.name};t=new LForms.LFormsData(t),$(".spinner").show(),t.loadFHIRResources(!1).then(function(){$(".spinner").hide(),m.$apply(function(){l.setFormData(t,s),g.setCurrentQuestionnaire(n.questionnaire)})})}}},m.showSavedQuestionnaire=function(i,o){o&&"Questionnaire"===o.resType&&($(".spinner").show(),d(),l.setFormData(null),a(function(){m.formSelected={groupIndex:2,formIndex:i};try{var e=lformsUpdater.update(o.questionnaire),n=LForms.Util.convertFHIRQuestionnaireToLForms(e,g.fhirVersion)}catch(e){c.error=e}if(!c.error){var t={resId:null,resType:null,resTypeDisplay:null,extensionType:null,questionnaireResId:o.resId,questionnaireName:o.questionnaire.name},r=new LForms.LFormsData(n);$(".spinner").show(),r.loadFHIRResources(!0).then(function(){$(".spinner").hide(),m.$apply(function(){l.setFormData(r,t),g.setCurrentQuestionnaire(o.questionnaire)})})}},10))},m.showFeaturedQ=function(e,n){n&&($(".spinner").show(),d(),l.setFormData(null),a(function(){m.formSelected={groupIndex:0,formIndex:e},g.getFhirResourceById("Questionnaire",n.id)},10))},m.isSelected=function(e,n){var t="";return m.formSelected&&m.formSelected.groupIndex===e&&m.formSelected.formIndex===n&&(t="active"),t},m.getSectionPanelClass=function(e){return m.listFeaturedQ?0===e?"in":"":m.listSavedQR&&0<m.listSavedQR.length?1===e?"in":"":m.listSavedQ&&0<m.listSavedQ.length&&2===e?"in":""},m.getSectionTitleClass=function(e){return"in"===m.getSectionPanelClass(e)?"":"collapsed"};var R="MM/dd/yyyy HH:mm:ss";m.$on("LF_FHIR_QUESTIONNAIRERESPONSE_LIST",function(e,n,t){if(m.listSavedQR=[],m.listSavedQRError=t,n&&"Bundle"==n.resourceType&&"searchset"==n.type&&n.entry){for(var r=0,i=n.entry.length;r<i;r++){var o=n.entry[r].resource;if("QuestionnaireResponse"===o.resourceType){var a;o.meta&&o.meta.lastUpdated?a=new Date(o.meta.lastUpdated).toString(R):o.authored&&(a=new Date(o.authored).toString(R));var s=null,l=null,c=o.questionnaire&&o.questionnaire.reference?o.questionnaire.reference:o.questionnaire;if(c){var d=c.slice("Questionnaire".length+1);s=g.findQuestionnaire(n,d)}if(s){l=v(s);var u=new RegExp("http://hl7.org/fhir/u./sdc/StructureDefinition/sdc-questionnaire\\|(\\d+.?\\d+)"),p=null;if(o.meta&&o.meta.profile)for(var f=0,h=o.meta.profile.length;f<h;f++)o.meta.profile[f].match(u)&&(p="SDC");m.listSavedQR.push({resId:o.id,resName:l,updatedAt:a,resType:"QuestionnaireResponse",questionnaire:s,questionnaireresponse:o,extensionType:p,resTypeDisplay:p?"QuestionnaireResponse (SDC)":"QuestionnaireResponse"})}}}m.processPagingLinks("QuestionnaireResponse",n.link),$(".spinner").hide()}m.$apply()}),m.$on("LF_FHIR_QUESTIONNAIRE_LIST",function(e,n,t){if(m.listSavedQ=[],m.listSavedQError=t,n&&"Bundle"==n.resourceType&&"searchset"==n.type&&n.entry){for(var r=0,i=n.entry.length;r<i;r++){var o,a=n.entry[r].resource;a.meta&&a.meta.lastUpdated?o=new Date(a.meta.lastUpdated).toString(R):a.date&&(o=new Date(a.date).toString(R)),m.listSavedQ.push({resId:a.id,resName:v(a),updatedAt:o,resType:"Questionnaire",questionnaire:a,resTypeDisplay:"Questionnaire"})}m.processPagingLinks("Questionnaire",n.link)}m.$apply(),$(".spinner").hide()}),m.$on("LF_FHIR_RESOURCE_DELETED",function(e,n){var t=g.getCurrentPatient();g.getAllQRByPatientId(t.id),g.getAllQ(),m.formSelected={},$(".spinner").hide()}),m.$on("LF_FHIR_Q_CREATED",function(e,n){g.getAllQ(),m.formSelected={groupIndex:2,formIndex:0},$(".spinner").hide()}),m.$on("OP_RESULTS",function(e,n){if(n&&n.successfulResults){var t=g.getCurrentPatient();g.getAllQRByPatientId(t.id),g.getAllQ(),m.formSelected={groupIndex:1,formIndex:0}}$(".spinner").hide()}),m.$on("LF_FHIR_RESOURCE_UPDATED",function(e,n){var t=g.getCurrentPatient();g.getAllQRByPatientId(t.id),m.formSelected={groupIndex:1,formIndex:0},$(".spinner").hide()}),m.$on("LF_FHIR_SERVER_SELECTED",function(e){m.listFeaturedQ=g.getFeaturedQs(),$(".spinner").hide()}),m.selectedQuestionnaire=null,m.showQuestionnairePicker=function(e){m.selectedQuestionnaireInDialog=null,t.show({scope:m,preserveScope:!0,templateUrl:"fhir-app/questionnaire-select-dialog.html",parent:angular.element(document.body),targetEvent:e,controller:["$scope","$mdDialog",function(n,t){n.dialogTitle="Questionnaire Picker",n.dialogLabel="Choose a Questionnaire",n.dialogHint="Search for Questionnaires by name",n.closeDialog=function(){n.selectedQuestionnaireInDialog=null,t.hide()},n.confirmAndCloseDialog=function(){n.selectedQuestionnaire=angular.copy(n.selectedQuestionnaireInDialog.resource);var e=LForms.Util.convertFHIRQuestionnaireToLForms(n.selectedQuestionnaire);e=lformsUpdater.update(e),l.setFormData(new LForms.LFormsData(e)),g.setCurrentQuestionnaire(n.selectedQuestionnaire),n.selectedQuestionnaireInDialog=null,t.hide()}}]})},m.deleteQuestionnaire=function(e){var n=t.confirm().title("Warning").textContent("This will delete the selected Questionnaire, all its saved QuestionnaireResponses, and all Observations extracted from those QuestionnaireResponses.").ok("Delete").cancel("Cancel").theme("warn");t.show(n).then(function(){g.deleteQAndQRespAndObs(g.currentQuestionnaire.id).then(function(){var e=t.alert().title("Deletion Completed").textContent("The questionnaire and its associated resources were deleted successfully.").ok("OK");t.show(e)})})},m.differentQuestionnaire=function(e,n){return e&&n&&e.id!==n.id},m.searchQuestionnaire=function(e){return g.searchQuestionnaire(e)}}]),angular.module("lformsApp").controller("FhirAppCtrl",["$scope","$timeout","$http","$location","$mdDialog","fhirService","fhirServerConfig",function(d,e,n,t,r,i,o){function a(n,t){d.showWaitMsg("Contacting FHIR server.  Please wait..."),i.setNonSmartServer(n,function(e){t&&t(e),e?d.showPatientPicker():d.showErrorMsg("Could not establish communication with the FHIR server at "+n.url+".")})}d.getCurrentPatient=function(){return i.getCurrentPatient()},d.getPatientName=function(){return i.getPatientName()},d.getPatientGender=function(){return i.getCurrentPatient().gender},d.getPatientDob=function(){return i.getCurrentPatient().birthDate},d.getPatientPhone=function(){return i.getPatientPhoneNumber()},e(function(){d.establishFHIRContext()},1),d.establishFHIRContext=function(){var e=t.search().server;e?a({url:e}):i.getSmartConnection()||i.smartConnectionInProgress()||i.requestSmartConnection(function(e){var n;e?i.getSmartConnection().patient.read().then(function(e){i.setCurrentPatient(e),i.getAllQRByPatientId(e.id),i.getAllQ(),d.$apply()}):(console.log("Could not establish a SMART connection."),(n=t.search().server)?a({url:n}):d.showFHIRServerPicker())})},d.showPatientPicker=function(e){d.selectedPatientInDialog=null,r.show({scope:d,preserveScope:!0,templateUrl:"fhir-app/patient-select-dialog.html",parent:angular.element(document.body),targetEvent:e,controller:["$scope","$mdDialog",function(n,t){n.dialogTitle="Patient Picker",n.dialogLabel="Choose a Patient",n.dialogHint="Search for patients by name",n.closeDialog=function(){n.selectedPatientInDialog=null,t.hide()},n.confirmAndCloseDialog=function(){var e=n.selectedPatientInDialog.resource;e&&(i.setCurrentPatient(e),i.setNonSmartServerPatient(e.id),i.getAllQRByPatientId(e.id),i.getAllQ()),n.selectedPatientInDialog=null,t.hide()}}]})},d.showSaveResults=function(t){r.show({scope:d,preserveScope:!0,templateUrl:"fhir-app/save-results-dialog.html",parent:angular.element(document.body),controller:["$scope","$mdDialog",function(e,n){e.dialogTitle="Save Results",e.resultData=t,e.resultDataJSON=JSON.stringify(t,null,2),e.serverBaseURL=i.getServerServiceURL(),e.closeDialog=function(){e.selectedPatientInDialog=null,n.hide()}}]})},d.showFHIRServerPicker=function(e){d.selectedServerInDialog=null,r.show({scope:d,preserveScope:!0,templateUrl:"fhir-app/fhir-server-select-dialog.html",parent:angular.element(document.body),targetEvent:e,controller:["$scope","$mdDialog",function(n,t){n.dialogTitle="FHIR Server Needed";var r=[];o.listFhirServers.map(function(e){r.push({text:e.url,serverConfig:e})}),n.fhirServerListOpts={listItems:r},n.closeDialog=function(){n.selectedServerInDialog=null,t.hide()},n.confirmAndCloseDialog=function(){if(n.selectedServerInDialog){var e=n.selectedServerInDialog;a(e._notOnList?{url:e.text}:e.serverConfig,function(){t.hide()})}n.selectedServerInDialog=null,t.hide()}}]})},d.$on("OP_FAILED",function(e,n){$(".spinner").hide();var t=n.errInfo;if(t&&t.error&&t.error.responseJSON&&t.error.responseJSON.issue){for(var r=t.error.responseJSON.issue,i='Unable to "'+n.operation+'" '+n.resType+".",o=!1,a=0,s=r.length;a<s&&!o;++a){var l=r[a];if("error"==l.severity||"fatal"==l.severity){var c=l.details&&l.details.text||l.diagnostics;c&&(i=c),o=!0}}console.log(i),d.showErrorMsg(i)}}),d.$on("OP_RESULTS",function(e,n){$(".spinner").hide(),d.showSaveResults(n)}),d.showErrorMsg=function(e){this.showMsg("Error",e)},d.showMsg=function(e,n){r.show(r.alert().parent(angular.element(document.body)).clickOutsideToClose(!0).title(e).textContent(n).ariaLabel(e+" Dialog").ok("OK"))},d.showWaitMsg=function(e){this.showMsg("Please Wait",e)},d.searchPatientByName=function(e){return i.searchPatientByName(e)}}]);var fb=angular.module("lformsApp");fb.service("fhirService",["$rootScope","$q","$http","$window","$timeout","fhirServerConfig",function(c,e,n,i,t,r){var d=this;d.currentPatient=null,d.fhir=null,d.currentQuestionnaire=null;var u=[],p=null;function o(e){var n=new URLSearchParams;if(e.query)for(var t,r=e.query,i=Object.keys(r),o=0,a=i.length;o<a;++o)t=i[o],n.append(t,r[t]);return d.fhir.request({url:e.type+"?"+n,headers:e.headers})}function f(e,n,t){c.$broadcast("OP_FAILED",{resType:e,operation:n,errInfo:t})}function h(){c.$broadcast("OP_RESULTS",{successfulResults:JSON.parse(JSON.stringify(u)),error:JSON.parse(JSON.stringify(p))}),u=[],p=null}function l(e,t){function r(){d.fhir.create(e).then(function(e){c.$broadcast("LF_FHIR_Q_CREATED",{resType:"Questionnaire",resource:e,resId:e.id,extensionType:"SDC"}),d.currentQuestionnaire=e,t(e)},function(e){p={resType:"Questionnaire",operation:"create",errInfo:e},h()})}var n;n?o({type:"Questionnaire",query:n,headers:{"Cache-Control":"no-cache"}}).then(function(e){if(0<(e.entry&&e.entry.length||0)){var n=e.entry[0].resource;t(n)}else r()},function(e){p={resType:"Questionnaire",operation:"search",errInfo:e},h()}):r()}d.requestSmartConnection=function(n){d.fhir=null,d._connectionInProgress||(d._connectionInProgress=!0,FHIR.oauth2.ready().then(function(e){d.setSmartConnection(e),d._connectionInProgress=!1,n(!0)}).catch(function(e){console.error(e),n(!1)}))},d.smartConnectionInProgress=function(){return d._connectionInProgress},d.getFeaturedQs=function(){return d._featuredQs},d.setSmartConnection=function(e){d.fhir=e,LForms.Util.setFHIRContext(e),LForms.Util.getServerFHIRReleaseID(function(e){d.fhirVersion=e});var n=d.getServerServiceURL(),t=r.listFhirServers.find(function(e){return e.smartServiceUrl===n});d._featuredQs=t?t.featuredQuestionnaires:null,c.$broadcast("LF_FHIR_SERVER_SELECTED")},d.setNonSmartServer=function(n,t){try{d.fhir=FHIR.client(n.url),LForms.Util.setFHIRContext(d.fhir),LForms.Util.getServerFHIRReleaseID(function(e){void 0!==e?(d.fhirVersion=e,t(!0)):t(!1)});var e=r.listFhirServers.find(function(e){return e.url===n.url});e&&(n=e),d._featuredQs=n.featuredQuestionnaires,c.$broadcast("LF_FHIR_SERVER_SELECTED")}catch(e){throw t(!1),e}},d.setNonSmartServerPatient=function(e){var n=d.getServerServiceURL();d.fhir=FHIR.client({serverUrl:n,tokenResponse:{patient:e}}),LForms.Util.setFHIRContext(d.fhir)},d.getSmartConnection=function(){return d.fhir},d.getServerServiceURL=function(){return d.getSmartConnection().state.serverUrl},d.setCurrentQuestionnaire=function(e){d.currentQuestionnaire=e,c.$broadcast("LF_FHIR_QUESTIONNAIRE_SELECTED",{resource:e})},d.getCurrentQuestionnaire=function(){return d.currentQuestionnaire},d.setCurrentPatient=function(e){d.currentPatient=e},d.getCurrentPatient=function(){return d.currentPatient},d.getPatientName=function(e){var n=e||d.currentPatient,t="";return n&&n.name&&0<n.name.length&&(n.name[0].given&&n.name[0].family?t=n.name[0].given[0]+" "+n.name[0].family:n.name[0].family?t=n.name[0].family:n.name[0].given&&(t=n.name[0].given[0])),t},d.getPatientPhoneNumber=function(e){var n=e||d.currentPatient,t="";if(n&&n.telecom)for(var r=0,i=n.telecom.length;r<i;r++)if("phone"===n.telecom[r].system&&n.telecom[r].value){t=n.telecom[r].use?n.telecom[r].use+": "+n.telecom[r].value:n.telecom[r].value;break}return t},d.getPage=function(n,e,t){var r=i.location.origin+"/fhir-api?";t=t.replace(/^.*\/baseDstu3\?/,r);d.fhir.request(t).then(function(e){"Questionnaire"===n?c.$broadcast("LF_FHIR_QUESTIONNAIRE_LIST",e):"QuestionnaireResponse"===n&&c.$broadcast("LF_FHIR_QUESTIONNAIRERESPONSE_LIST",e)},function(e){console.log(e)})},d.searchPatientByName=function(e){return o({type:"Patient",query:{name:e},headers:{"Cache-Control":"no-cache"}}).then(function(e){var n=[];if(e&&e.entry)for(var t=0,r=e.entry.length;t<r;t++){var i=e.entry[t].resource;n.push({name:d.getPatientName(i),gender:i.gender,dob:i.birthDate,phone:d.getPatientPhoneNumber(i),id:i.id,resource:i})}return n},function(e){console.log(e)})},d.searchQuestionnaire=function(e){return o({type:"Questionnaire",query:{title:e},headers:{"Cache-Control":"no-cache"}}).then(function(e){var n=[];if(e&&e.entry)for(var t=0,r=e.entry.length;t<r;t++){var i=e.entry[t].resource;n.push({title:i.title,status:i.status,id:i.id,resource:i})}return n},function(e){console.log(e)})},d.getFhirResourceById=function(n,t){d.fhir.request(n+"/"+encodeURIComponent(t)).then(function(e){c.$broadcast("LF_FHIR_RESOURCE",{resType:n,resource:e,resId:t})},function(e){console.log(e)})},d.getMergedQQR=function(e,n){o({type:e,query:{_id:n,_include:"QuestionnaireResponse:questionnaire"},headers:{"Cache-Control":"no-cache"}}).then(function(e){var n={qResource:null,qrResource:null},t=e.entry.length;if(0!==t&&(1===t||2===t))for(var r=0;r<t;r++){var i=e.entry[r].resource;"QuestionnaireResponse"===i.resourceType?n.qrResource=i:"Questionnaire"===i.resourceType&&(n.qResource=i)}c.$broadcast("LF_FHIR_MERGED_QQR",n)},function(e){console.log(e)})},d.setQRRefToQ=function(e,n){var t=n.id;"STU3"===d.fhirVersion?e.questionnaire={reference:"Questionnaire/"+t}:e.questionnaire="Questionnaire/"+t},d.createQR=function(e,n){d.setQRRefToQ(e,n),d.fhir.create(e).then(function(e){c.$broadcast("LF_FHIR_QR_CREATED",{resType:"QuestionnaireResponse",resource:e,resId:e.id,qResId:n.id,qName:n.name,extensionType:"SDC"}),u.push(e),h()},function(e){console.log(e),p=e,h()})},d.createQQRObs=function(e,n,t,r){p=null;var i={resourceType:"Bundle",type:"transaction",entry:[]};i.entry.push({resource:n,request:{method:"POST",url:"QuestionnaireResponse"}});for(var o=0,a=t.length;o<a;++o)i.entry.push({resource:t[o],request:{method:"POST",url:"Observation"}});function s(s){var l=i.entry[0].resource,e="Questionnaire/"+s.id;"STU3"==d.fhirVersion?l.questionnaire={reference:e}:l.questionnaire=e,d.fhir.request({url:"",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(function(e){u.push(e),h();for(var n=e.entry,t=null,r=0,i=n.length;r<i&&!t;++r){var o=n[r],a=o.response&&o.response.location&&o.response.location.match(/^QuestionnaireResponse\/(\d+)/);a&&(t=a[1])}c.$broadcast("LF_FHIR_QR_CREATED",{resType:"QuestionnaireResponse",resource:l,resId:t,qResId:s.id,qName:s.name,extensionType:"SDC"})},function(e){p={resType:"Bundle",operation:"create",errInfo:e},h()})}r?s(e):l(e,s)},d.createQQR=function(e,n,t){l(e,function(e){d.createQR(n,e)})},d.updateFhirResource=function(n,t){d.fhir.update(t).then(function(e){c.$broadcast("LF_FHIR_RESOURCE_UPDATED",{resType:n,resource:e,resId:t.id})},function(e){console.log(e),f(n,"update",e)})},d.deleteQRespAndObs=function(l,c){return"STU3"===d.fhirVersion?d.deleteFhirResource("QuestionnaireResponse",l,c):o({type:"Observation",query:{"derived-from":"QuestionnaireResponse/"+l},headers:{"Cache-Control":"no-cache"}}).then(function(e){var n,t=e.entry;if(t&&0<t.length){for(var r=!1,i=[],o=0,a=t.length;o<a;++o){var s=t[o].resource.id;i.push(d.fhir.delete({type:"Observation",id:s}))}n=Promise.all(i).then(function(){return d.deleteFhirResource("QuestionnaireResponse",l,c)},function(e){r||(r=!0,console.log(e),f("QuestionnaireResponse","delete",e))})}else n=d.deleteFhirResource("QuestionnaireResponse",l,c);return n},function(e){console.log(e),f("QuestionnaireResponse","delete",e)})},d.deleteQAndQRespAndObs=function(s){return o({type:"QuestionnaireResponse",query:{questionnaire:"Questionnaire/"+s},headers:{"Cache-Control":"no-cache"}}).then(function(e){var n,t=e.entry;if(t&&0<t.length){for(var r=[],i=0,o=t.length;i<o;++i){var a=t[i].resource.id;r.push(d.deleteQRespAndObs(a,!1))}n=Promise.all(r).then(function(){d.deleteFhirResource("Questionnaire",s)},function(e){console.log(e),f("QuestionnaireResponse","delete",e)})}else n=d.deleteFhirResource("Questionnaire",s);return n},function(e){console.log(e),f("QuestionnaireResponse","delete",e)})},d.deleteFhirResource=function(n,e,t){return void 0===t&&(t=!0),d.fhir.delete({type:n,id:e}).then(function(){t&&c.$broadcast("LF_FHIR_RESOURCE_DELETED",{resType:n,resource:null,resId:e})},function(e){console.log(e),f(n,"delete",e)})},d.getDRAndObxBundle=function(e,n){o({type:"DiagnosticReport",query:{_id:n,_include:"DiagnosticReport:result"},headers:{"Cache-Control":"no-cache"}}).then(function(e){c.$broadcast("LF_FHIR_DR_OBX_BUNDLE",e)},function(e){console.log(e)})},d.handleTransactionBundle=function(e){d.fhir.transaction({bundle:e}).then(function(e){c.$broadcast("LF_FHIR_BUNDLE_PROCESSED",{resType:"Bundle",resource:e,resId:e.id,qResId:qID,qName:qData.name,extensionType:extensionType})},function(e){console.log(e),f("Bundle","create",e)})},d.getAllQRByPatientId=function(e){o({type:"QuestionnaireResponse",query:{subject:"Patient/"+e,_include:"QuestionnaireResponse:questionnaire",_sort:"-_lastUpdated",_count:5},headers:{"Cache-Control":"no-cache"}}).then(function(e){c.$broadcast("LF_FHIR_QUESTIONNAIRERESPONSE_LIST",e)},function(e){c.$broadcast("LF_FHIR_QUESTIONNAIRERESPONSE_LIST",null,e),console.log(e)})},d.findQuestionnaire=function(e,n){var t=null;if(e)for(var r=0,i=e.entry.length;r<i;r++){var o=e.entry[r].resource;if("Questionnaire"===o.resourceType&&o.id===n){t=o;break}}return t},d.getAllQ=function(){o({type:"Questionnaire",query:{_sort:"-_lastUpdated",_count:10},headers:{"Cache-Control":"no-cache"}}).then(function(e){c.$broadcast("LF_FHIR_QUESTIONNAIRE_LIST",e)},function(e){c.$broadcast("LF_FHIR_QUESTIONNAIRE_LIST",null,e),console.log(e)})}}]),angular.module("lformsApp").service("selectedFormData",["$rootScope",function(t){var r={lfData:null,fhirResInfo:{resId:null,resType:null,resTypeDisplay:null,extensionType:null,questionnaireResId:null,questionnaireName:null}};return{getFormData:function(){return r.lfData},getFhirResInfo:function(){return r.fhirResInfo},getFhirResourceId:function(){return r.fhirResInfo.resId},getFhirResourceType:function(){return r.fhirResInfo.resType},setFormData:function(e,n){r.lfData=e,r.fhirResInfo=n||{resId:null,resType:null,resTypeDisplay:null,extensionType:null,questionnaireResId:null,questionnaireName:null},t.$broadcast("LF_NEW_DATA")}}}]),angular.module("lformsApp").service("userMessages",["$rootScope",function(e){return{}}]),angular.module("lformsApp").run(["$templateCache",function(e){e.put("fhir-app/fhir-app-content.html",'<div class=demo-app ng-controller=FhirAppContentCtrl>\x3c!--<p class="status-bar" ng-if="formData">--\x3e\x3c!--<span class="status-label" flex="50">--\x3e\x3c!--<span class="">Resource Type:</span>--\x3e\x3c!--<span class="text-primary">{{fhirResInfo.resTypeDisplay}}</span>--\x3e\x3c!--</span>--\x3e\x3c!--<span class="status-label" flex="50">--\x3e\x3c!--<span class="">Resource ID:</span>--\x3e\x3c!--<span class="text-primary">{{fhirResInfo.resId}}</span>--\x3e\x3c!--</span>--\x3e\x3c!--</p>--\x3e<div class="btn-group btn-group-sm" role=group ng-if=formData><button ng-if="formData && fhirResInfo.resId" type=button class="btn btn-primary" ng-click=saveQRToFhir() id=btn-save data-toggle=tooltip data-placement=bottom title="Save/Update the form data as a FHIR resource to the selected FHIR server."><span class="glyphicon glyphicon-cloud-upload"></span> <span>Save</span></button> <button ng-if="formData && fhirResInfo.resId" type=button class="btn btn-primary" ng-click=deleteFromFhir() id=btn-delete data-toggle=tooltip data-placement=bottom title="Delete the FHIR resource from the selected FHIR server."><span class="glyphicon glyphicon-trash"></span> <span>Delete</span></button></div><div class="btn-group btn-group-sm" role=group ng-if=formData><button type=button class="btn dropdown-toggle btn-primary" data-toggle=dropdown aria-haspopup=true aria-expanded=false id=btn-save-as data-toggle=tooltip data-placement=bottom title="Save the form data as a \'new\' FHIR resource to the selected FHIR server."><span class="glyphicon glyphicon-share"></span> <span>Save As ... </span><span class=caret></span></button><ul class=dropdown-menu>\x3c!--<li><a href="#" class="" id="btn-save-qr" ng-click="saveAsToFhir(\'QR\')">FHIR QuestionnaireResponse</a></li>--\x3e<li><a href=# id=btn-save-sdc-qr ng-click="saveAsToFhir(\'SDC-QR\')">FHIR QuestionnaireResponse (SDC)</a></li><li><a href=# id=btn-save-sdc-qr-obs ng-click=saveAsQRExtracted()>FHIR QuestionnaireResponse (SDC) &amp; Observations</a></li>\x3c!--<li><a href="#" class="" ng-click="saveAsToFhir(\'DR\')">FHIR DiagnosticReport</a></li>--\x3e</ul></div><div class="btn-group btn-group-sm" role=group ng-if=formData><button type=button class="btn dropdown-toggle btn-primary" data-toggle=dropdown aria-haspopup=true aria-expanded=false id=btn-show-as data-toggle=tooltip data-placement=bottom title="Show\n     the form data as a FHIR resource in a popup window."><span class="glyphicon glyphicon-modal-window"></span> <span>Show As ... </span><span class=caret></span></button><ul class=dropdown-menu><li ng-if=fhirResInfo.questionnaireResId><a id=show-q-from-server href=# ng-click=showOrigFHIRQuestionnaire()>FHIR Questionnaire from Server</a></li><li ng-if=fhirResInfo.questionnaireResId role=separator class=divider></li>\x3c!--<li><a id="show-q" href="#" class="" ng-click="showFHIRQuestionnaire()">FHIR Questionnaire</a></li>--\x3e\x3c!--<li><a id="show-qr" href="#" class="" ng-click="showFHIRQuestionnaireResponse()">FHIR QuestionnaireResponse</a></li>--\x3e\x3c!--<li role="separator" class="divider"></li>--\x3e<li><a id=show-sdc-q href=# ng-click=showFHIRSDCQuestionnaire()>FHIR Questionnaire (SDC)</a></li><li><a id=show-sdc-qr href=# ng-click=showFHIRSDCQuestionnaireResponse()>FHIR QuestionnaireResponse (SDC)</a></li>\x3c!--<li role="separator" class="divider"></li>--\x3e\x3c!--<li><a href="#" class="" ng-click="showFHIRDiagnosticReport()">FHIR DiagnosticReport</a></li>--\x3e\x3c!--<li role="separator" class="divider"></li>--\x3e\x3c!--<li><a href="#" class="" ng-click="showHL7Segments()">HL7 v2 Message</a></li>--\x3e</ul></div><div ng-if=initialLoad ng-include="\'initial.html\'"></div><div ng-if=userMessages.error class=error>{{userMessages.error}}</div><div ng-if=userMessages.htmlError class=error ng-bind-html=userMessages.htmlError></div><div ng-if=userMessages.htmlWarning class=warning ng-bind-html=userMessages.htmlWarning></div><div ng-if="!initialLoad && !formData && !userMessages.error &&\n    !userMessages.htmlError" ng-include="\'loading.html\'"></div><lforms lf-data=formData lf-options=lfOptions></lforms>\x3c!-- inline templates. these could be in template files too. --\x3e<script type=text/ng-template id=initial.html><div class="loading initial">\n      <span>Please select a FHIR resource or upload from file.</span>\n    </div><\/script><script type=text/ng-template id=loading.html><div class="loading">\n      <span>Loading...</span>\n    </div><\/script>\x3c!-- end of inline templates --\x3e</div>'),e.put("fhir-app/fhir-app-navbar.html",'<div ng-controller=NavBarCtrl><div class=panel><div class=panel-body><input type=file id=inputAnchor nv-file-select uploader=uploader class=hide><div class="btn-group btn-group-justified" role=group><a id=upload role=button type=button class="btn btn-default btn-sm btn-success" ng-click=loadFromFile() title="Upload a file."><span class="glyphicon glyphicon-upload"></span><span class=lf-nav-button>Upload</span></a></div><p>If you do not have a Questionnaire of your own to upload, you can try downloading one of our <a href=https://raw.githubusercontent.com/lhncbc/lforms-fhir-app/master/e2e-tests/data/R4/weight-height-questionnaire.json target=_blank rel="noopener noreferrer" id=sampleQ>samples</a> (saving it to file, and then uploading it here).</p></div></div><div class=panel-group id=listAccordion role=tablist aria-multiselectable=true><div class="panel panel-default"><div class=panel-heading role=tab id=heading-one><div class=panel-title><a role=button class={{getSectionTitleClass(1)}} data-toggle=collapse data-target=#collapse-one data-parent=#listAccordion aria-expanded=false aria-controls=collapse-one>Saved QuestionnaireResponses</a></div></div><div class="panel-collapse collapse {{getSectionPanelClass(1)}}" id=collapse-one role=tabpanel aria-labelledby=heading-one><div ng-if=listSavedQRError>Unable to retrieve saved QuestionnaireResponses.</div><div ng-if="!listSavedQRError && !listSavedQR">Loading QuestionnaireResponses from server...</div><div ng-if="!listSavedQRError && listSavedQR && listSavedQR.length==0">No saved QuestionnaireResponse resources were found for this patient.</div><div ng-if="listSavedQR && listSavedQR.length>0" id=qrList class=list-group><a href=# class="list-group-item {{isSelected(1, $index)}}" ng-repeat="p in listSavedQR" role=presentation id={{p.resId}} ng-click="showSavedQQR($index, p)"><p class=form-name>{{p.resName}}</p><p class=res-type ng-if=p.extensionType>{{p.resTypeDisplay}}</p><p class=last-updated>{{p.updatedAt}}</p></a><div class="btn-group btn-group-justified" role=group><a role=button type=button class="btn btn-default btn-sm glyphicon glyphicon-chevron-left" ng-disabled="!hasPagingLink(\'QuestionnaireResponse\',\'previous\')" ng-click="getPage(\'QuestionnaireResponse\', \'previous\')"></a> <a role=button type=button class="btn btn-default btn-sm glyphicon glyphicon-chevron-right" ng-disabled="!hasPagingLink(\'QuestionnaireResponse\',\'next\')" ng-click="getPage(\'QuestionnaireResponse\', \'next\')"></a></div></div></div></div><div ng-if=listFeaturedQ class="panel panel-default"><div class=panel-heading role=tab id=heading-two><div class=panel-title><a role=button class={{getSectionTitleClass(0)}} data-toggle=collapse data-target=#collapse-two data-parent=#listAccordion aria-expanded=false aria-controls=collapse-two>Featured Questionnaires:</a></div></div><div class="panel-collapse collapse {{getSectionPanelClass(0)}}" id=collapse-two role=tabpanel aria-labelledby=heading-two><div ng-if="listFeaturedQ && listFeaturedQ.length>0" id=fqList class=list-group><a href=# class="list-group-item {{isSelected(0, $index)}}" ng-repeat="p in listFeaturedQ" role=presentation id={{p.id}} ng-click="showFeaturedQ($index, p)"><p class=form-name>{{p.name}} <span ng-if=p.code>[{{p.code}}]</span></p></a></div></div></div><div class="panel panel-default"><div class=panel-heading role=tab id=heading-three><div class=panel-title><a role=button class={{getSectionTitleClass(2)}} data-toggle=collapse data-target=#collapse-three data-parent=#listAccordion aria-expanded=false aria-controls=collapse-three>Available Questionnaires: </a><span class=showDate><label><input type=checkbox ng-model=showQDate> Show Date</label></span></div></div><div class="panel-collapse collapse {{getSectionPanelClass(2)}}" id=collapse-three role=tabpanel aria-labelledby=heading-three><div ng-if=listSavedQError>Unable to retrieve saved Questionnaires.</div><div ng-if="!listSavedQError && !listSavedQ">Loading Questionnaires from server...</div><div ng-if="!listSavedQError && listSavedQ && listSavedQ.length==0">No saved Questionnaire resources were found. Try uploading one.</div><div ng-if="listSavedQ && listSavedQ.length>0" id=qList class=list-group><div class="btn-group btn-group-justified" role=group><a id=search role=button type=button class="btn btn-default btn-sm btn-success" ng-click=showQuestionnairePicker($event) title="Choose a Questionnaire from the FHIR server."><span class="glyphicon glyphicon-search"></span><span class=lf-nav-button>Search</span></a></div><a href=# class="list-group-item {{isSelected(2, $index)}}" ng-repeat="p in listSavedQ" role=presentation id={{p.resId}} ng-click="showSavedQuestionnaire($index, p)"><p class=form-name>{{p.resName}}</p><p class=last-updated ng-if=showQDate>{{p.updatedAt}}</p></a><div class="btn-group btn-group-justified" role=group><a id=prevQPage role=button type=button class="btn btn-default btn-sm glyphicon glyphicon-chevron-left" ng-disabled="!hasPagingLink(\'Questionnaire\',\'previous\')" ng-click="getPage(\'Questionnaire\', \'previous\')"></a> <a id=nextQPage role=button type=button class="btn btn-default btn-sm glyphicon glyphicon-chevron-right" ng-disabled="!hasPagingLink(\'Questionnaire\',\'next\')" ng-click="getPage(\'Questionnaire\', \'next\')"></a></div><div style="display: none" ng-if=formSelected.groupIndex id=deleteQBtn class="btn-group btn-group-justified" role=group><a role=button type=button class="btn btn-default btn-sm btn-danger" ng-click=deleteQuestionnaire($event) title="Deletes\n             a Questionnaire and associated QuestionnaireResponses and\n             Observations"><span class="glyphicon glyphicon-warning-sign"></span><span class=lf-nav-button>Delete Questionnaire and Its Responses</span></a></div></div></div></div></div></div>'),e.put("fhir-app/fhir-app.html",'\x3c!-- page header --\x3e<div id=header><a href=http://lhncbc.nlm.nih.gov title="Lister Hill Center" id=logo><img src=assets/images/lhncbc.jpg alt="Lister Hill Center"></a><div id=siteNameBox><span id=siteName>SDC Questionnaire App</span><br></div><div id=tagLine>An open-source app for Structured Data Capture Questionnaires, powered by the <a target=_blank rel=noopener href=https://lhcforms.nlm.nih.gov>LHC-Forms</a> form rendering widget</div><div id=version>Version: <a target=_blank rel="noopener noreferrer" href=https://github.com/lhncbc/lforms-fhir-app/blob/master/CHANGELOG.md>1.0.0</a></div></div>\x3c!-- end page header --\x3e<div><md-toolbar class=lf-patient><div class=md-toolbar-tools><span class="glyphicon glyphicon-user"></span> <span ng-if=getCurrentPatient() flex="" class=lf-patient-info><div id=ptName class="col-xs-6 col-md-3">Name: {{getPatientName()}}</div><div class="col-xs-6 col-md-3">Gender: {{getPatientGender()}}</div><div class="col-xs-6 col-md-3">DoB: {{getPatientDob()}}</div><div class="col-xs-6 col-md-3">Phone: {{getPatientPhone()}}</div></span></div></md-toolbar><md-content><div class=lf-content><div class="col-md-4 form-nav" ng-include="\'fhir-app/fhir-app-navbar.html\'"></div><div class="col-md-8 form-content" ng-include="\'fhir-app/fhir-app-content.html\'"></div></div></md-content></div>\x3c!-- page footer --\x3e<div id=fine-print><ul class=horz-list><li><a title="NLM copyright information" href=http://www.nlm.nih.gov/copyright.html>Copyright</a></li><li><a title="NLM privacy policy" href=http://www.nlm.nih.gov/privacy.html>Privacy</a></li><li><a title="NLM accessibility" href=http://www.nlm.nih.gov/accessibility.html>Accessibility</a></li><li><a title="NIH Freedom of Information Act office" href=http://www.nih.gov/icd/od/foia/index.htm>Freedom of Information Act</a></li><li class=last-item><a title=USA.gov href=http://www.usa.gov/ ><img src=assets/images/USAgov.gif alt=USA.gov id=usagov></a></li></ul><ul class=horz-list><li><a title="U.S. National Library of Medicine" href=http://www.nlm.nih.gov/ >U.S. National Library of Medicine</a></li><li><a title="U.S. National Institutes of Health" href=http://www.nih.gov/ >U.S. National Institutes of Health</a></li><li class=last-item><a title="U.S. Department of Health and Human Services" href=http://www.hhs.gov/ >U.S. Department of Health and Human Services</a></li></ul></div>\x3c!-- end page footer --\x3e'),e.put("fhir-app/fhir-resource-dialog.html",'<md-dialog flex=50 ng-controller=FhirAppContentCtrl><form><md-toolbar><div class=md-toolbar-tools><h2 ng-bind-html=fhirResourceTitle></h2></div></md-toolbar><md-dialog-content><div><pre id=message-body ng-bind-html=fhirResourceString></pre></div></md-dialog-content><md-dialog-actions layout=row><md-button aria-label="Copy to clipboard" ng-click="copyToClipboard(\'message-body\')" class=md-primary>Copy to Clipboard</md-button><md-button id=close-res-dialog aria-label="Close dialog" ng-click=closeDialog() class=md-primary>Close</md-button></md-dialog-actions></form></md-dialog>'),e.put("fhir-app/fhir-server-select-dialog.html",'<md-dialog flex=45><form><md-toolbar><div class=md-toolbar-tools><h2 ng-bind-html=dialogTitle></h2></div></md-toolbar><md-dialog-content><div><p>Note: The preferred way of running this app is through a SMART on FHIR launcher, such as <a href=https://apps.smarthealthit.org/app/lforms-questionnaire-app>this one</a>.</p><p>Select or Enter the base URL of a FHIR Server. A list of public <a href=https://confluence.hl7.org/display/FHIR/Public+Test+Servers>FHIR server URLs</a> is available from HL7.</p><div layout=column ng-cloak><md-content layout-padding layout=column><form><input id=fhirServerURL ng-model=selectedServerInDialog autocomplete-lhc=fhirServerListOpts style="background-color: white"></form></md-content></div></div></md-dialog-content><md-dialog-actions layout=row><md-button id=btnOK aria-label=OK ng-click=confirmAndCloseDialog() class=md-primary>OK</md-button><md-button id=btnCancel aria-label=Cancel ng-click=closeDialog() class=md-primary>Cancel</md-button></md-dialog-actions></form></md-dialog>'),e.put("fhir-app/hl7-dialog.html",'<md-dialog flex=50 ng-controller=FhirAppContentCtrl><form><md-toolbar><div class=md-toolbar-tools><h2>HL7 OBR & OBX Segments</h2></div></md-toolbar><md-dialog-content><div><p>Please note that this is still a work in progress, and the code system values might be incorrect in some places.</p><pre id=message-body ng-bind-html=hl7String></pre></div></md-dialog-content><md-dialog-actions layout=row><md-button aria-label="Copy to clipboard" ng-click="copyToClipboard(\'message-body\')" class=md-primary>Copy to Clipboard</md-button><md-button aria-label="Close dialog" ng-click=closeDialog() class=md-primary>Close</md-button></md-dialog-actions></form></md-dialog>'),e.put("fhir-app/patient-select-dialog.html",'<md-dialog flex=45><form><md-toolbar><div class=md-toolbar-tools><h2 ng-bind-html=dialogTitle></h2></div></md-toolbar><md-dialog-content><div><p>{{dialogLabel}}</p><div layout=column ng-cloak><md-content layout-padding layout=column><form><md-autocomplete md-no-cache=false md-selected-item=selectedPatientInDialog md-search-text=patientSearchText md-items="item in searchPatientByName(patientSearchText)" md-item-text=item.name md-min-length=1 placeholder={{dialogHint}} md-menu-class=autocomplete-custom-template class=lf-patient-search><md-item-template><span class=item-title><span class="glyphicon glyphicon-user"></span> <span class=item-property><strong>{{item.name}} </strong></span></span><span class=item-metadata><span class=item-property>Gender: <strong>{{item.gender}}</strong> </span><span class=item-property>DoB: <strong>{{item.dob}}</strong> </span><span class=item-property>Phone: <strong>{{item.phone}}</strong></span></span></md-item-template><md-not-found>No patients found.</md-not-found></md-autocomplete></form></md-content></div></div></md-dialog-content><md-dialog-actions layout=row class=lost-data-warning ng-if="differentPatient(selectedPatient, selectedPatientInDialog)"><span>* Unsaved data in the form will be lost if you change to a different patient.</span> <span flex></span></md-dialog-actions><md-dialog-actions layout=row><md-button id=btnOK ng-if=selectedPatientInDialog aria-label=OK ng-click=confirmAndCloseDialog() class=md-primary>OK</md-button><md-button id=btnCancel aria-label=Cancel ng-click=closeDialog() class=md-primary>Cancel</md-button></md-dialog-actions></form></md-dialog>'),e.put("fhir-app/questionnaire-select-dialog.html",'<md-dialog flex=45><form><md-toolbar><div class=md-toolbar-tools><h2 ng-bind-html=dialogTitle></h2></div></md-toolbar><md-dialog-content><div><p>{{dialogLabel}}</p><div layout=column ng-cloak><md-content layout-padding layout=column><form><md-autocomplete md-no-cache=false md-selected-item=selectedQuestionnaireInDialog md-search-text=questionnaireSearchText md-items="item in searchQuestionnaire(questionnaireSearchText)" md-item-text=item.title md-min-length=1 placeholder={{dialogHint}} md-menu-class=autocomplete-custom-template class=lf-patient-search><md-item-template><span class=item-title><span class="glyphicon glyphicon-user"></span> <span class=item-property><strong>{{item.title}} </strong></span></span><span class=item-metadata><span class=item-property>Status: <strong>{{item.status}}</strong></span></span></md-item-template><md-not-found>No Questionnaires found.</md-not-found></md-autocomplete></form></md-content></div></div></md-dialog-content><md-dialog-actions layout=row class=lost-data-warning ng-if="differentQuestionnaire(selectedQuestionnaire, selectedQuestionnaireInDialog)"><span>* Unsaved data in the form will be lost if you choose a difference Questionnaire.</span> <span flex></span></md-dialog-actions><md-dialog-actions layout=row><md-button id=btnOK ng-if=selectedQuestionnaireInDialog aria-label=OK ng-click=confirmAndCloseDialog() class=md-primary>OK</md-button><md-button id=btnCancel aria-label=Cancel ng-click=closeDialog() class=md-primary>Cancel</md-button></md-dialog-actions></form></md-dialog>'),e.put("fhir-app/save-results-dialog.html","<md-dialog flex=45 ng-controller=FhirAppContentCtrl><form><md-toolbar><div class=md-toolbar-tools><h2 ng-bind-html=dialogTitle></h2></div></md-toolbar><md-dialog-content><div><p>Save {{resultData.error && resultData.successfulResults ? 'partially ' : ''}}{{ resultData.error ? 'failed' : 'succeeded'}}.</p><ul ng-repeat=\"result in resultData.successfulResults\"><li ng-repeat=\"entry in result.entry\">\x3c!-- bundle --\x3e {{entry.response.status.slice(4)}} <a href={{serverBaseURL}}/{{entry.response.location}} target=_blank>{{entry.response.location}}</a></li><li ng-if=\"result.resourceType != 'Bundle'\">{{result.config.method='POST' ? 'Created' : result.config.method='PUT' ? 'Updated' : result.config.method}} <a href={{serverBaseURL}}/{{result.resourceType}}/{{result.id}} target=_blank>{{result.resourceType}}/{{result.id}}</a></li></ul><a href=# onclick=\"$('#details').toggle(); $('#copyBtn').toggle(); return false\">Details</a><pre id=details style=\"display: none\">{{resultDataJSON}}</pre></div></md-dialog-content><md-dialog-actions layout=row><md-button id=copyBtn aria-label=\"Copy to clipboard\" style=\"display: none\" ng-click=\"copyToClipboard('details')\" class=md-primary>Copy to Clipboard</md-button><md-button id=btnOK aria-label=OK ng-click=closeDialog() class=md-primary>OK</md-button></md-dialog-actions></form></md-dialog>")}]);